@startuml data-architecture
!define DATA_COMPONENT #E3F2FD
!define DATA_FLOW #FFF9C4

skinparam linetype ortho

skinparam component {
    BackgroundColor<<DataEntity>> DATA_COMPONENT
    BackgroundColor<<DataFlow>> DATA_FLOW
    BorderColor #333333
    ArrowColor #333333
}

title TOGAF Data Architecture - FinPulse Fintech Platform

package "Core Data Entities" {
    component "Portfolio Data" as PortfolioData <<DataEntity>>
    component "Asset Data" as AssetData <<DataEntity>>
    component "Transaction Data" as TransactionData <<DataEntity>>
    component "Market Data" as MarketData <<DataEntity>>
    component "Watchlist Data" as WatchListData <<DataEntity>>
    component "Risk Metrics Data" as RiskMetricsData <<DataEntity>>
    component "User Preference Data" as UserPreferenceData <<DataEntity>>
    component "User Data" as UserData <<DataEntity>>

    note right of PortfolioData
        <b>Attributes</b>
        - portfolio_id (UUID)
        - user_id (UUID)
        - NAV (Decimal)
        - today P/L (Decimal)
        - cumulative return (Decimal)
        - active trades (Integer)
    end note

    note right of AssetData
        <b>Attributes</b>
        - asset_id (UUID)
        - portfolio_id (UUID)
        - symbol (String)
        - quantity (Decimal)
        - price (Decimal)
        - market_value (Decimal)
        - type (Enum: stock/bond/option)
    end note

    note right of TransactionData
        <b>Attributes</b>
        - transaction_id (UUID)
        - user_id, portfolio_id (UUID)
        - symbol (String)
        - type (Enum), amount (Decimal)
        - timestamp (DateTime)
    end note

    note right of MarketData
        <b>Attributes</b>
        - data_id (UUID), symbol (String)
        - timestamp (DateTime)
        - open/close (Decimal)
        - high/low (Decimal)
        - volume, change_pct (Decimal)
    end note

    note right of RiskMetricsData
        <b>Attributes</b>
        - metric_id, portfolio_id (UUID)
        - risk_level (Enum)
        - volatility, Sharpe (Decimal)
        - VaR, Beta (Decimal)
    end note
}

package "Finance Calculation Entities" {
    component "Bond Data" as BondData <<DataEntity>>
    component "Options Data" as OptionsData <<DataEntity>>
    component "Technical Indicator Data" as TechnicalIndicatorData <<DataEntity>>
    component "Portfolio Optimization Data" as PortfolioOptimizationData <<DataEntity>>
    component "Statistical Data" as StatisticalData <<DataEntity>>
    component "Valuation Data" as ValuationData <<DataEntity>>

    note right of BondData
        <b>Attributes</b>
        - bond_id (UUID), face_value, coupon (Decimal)
        - YTM, duration, convexity (Decimal)
        - maturity, frequency (Integer)
    end note

    note right of OptionsData
        <b>Attributes</b>
        - option_id (UUID), underlying (String)
        - strike, expiry, type (Call/Put)
        - rate, vol, BS price, Greeks, implied vol
    end note

    note right of TechnicalIndicatorData
        <b>Attributes</b>
        - indicator_id, symbol, timestamp
        - MA/EMA, RSI, MACD, volatility, volume
    end note

    note right of PortfolioOptimizationData
        <b>Attributes</b>
        - optimization_id, portfolio_id
        - weights (Array), expected return, variance
        - Sharpe, efficient frontier, constraints (JSON)
    end note

    note right of StatisticalData
        <b>Attributes</b>
        - stat_id, symbol1, symbol2
        - correlation, Beta, Alpha
        - Fama-French factors, regression coefs
    end note

    note right of ValuationData
        <b>Attributes</b>
        - valuation_id, symbol
        - method (DCF/DDM/relative)
        - EV, equity value, target price
        - multiples, discount rate, growth
    end note
}

package "Big Data Storage Entities" {
    component "Spark Data Entity" as SparkDataEntity <<DataEntity>>
    component "Flink Data Entity" as FlinkDataEntity <<DataEntity>>
    component "Hadoop Data Entity" as HadoopDataEntity <<DataEntity>>

    note right of SparkDataEntity
        <b>Attributes</b>
        - SparkSession ID, Application ID
        - DataFrame/Dataset, SQL results
        - batch job ID, status, execution plan
    end note

    note right of FlinkDataEntity
        <b>Attributes</b>
        - Environment ID, Job ID
        - DataStream, Table
        - job status, checkpoint, cluster metrics
    end note

    note right of HadoopDataEntity
        <b>Attributes</b>
        - HDFS path, file size, block size
        - replicas, YARN app ID, status
        - MapReduce job ID, node count, metrics
    end note
}

package "Portfolio Analytics Storage" {
    component "TimescaleDB (PostgreSQL)" as TimescaleDB <<DataEntity>>
    component "Redis (cache)" as RedisCache <<DataEntity>>
    component "Kafka (portfolio.events)" as KafkaPortfolioEvents <<DataFlow>>
    component "Kafka (market.quotes.enriched)" as KafkaQuotesEnriched <<DataFlow>>

    note right of TimescaleDB
        <b>Schema (Alembic)</b>
        - portfolio (id PK, data JSONB)
        - portfolio_history (time, portfolio_id, value) hypertable
        - SQLAlchemy 2.0 + asyncpg
        - Seed via POST /api/v1/seed
        - GET /api/v1/portfolio reads from DB
    end note
    note right of RedisCache
        <b>Cache</b>
        - portfolio:history:{id}:{days}d
        - TTL 300s
        - Invalidated on seed
    end note
    note right of KafkaPortfolioEvents
        <b>Events</b>
        - type: portfolio.seeded
        - portfolio_id, payload (full portfolio JSON)
    end note
    note right of KafkaQuotesEnriched
        <b>Events</b>
        - symbol-keyed enriched quotes
        - price, change, changeRate, timestamp
        - consumed by MarketDataService and mobile portfolio WebSocket (/ws/quotes)
    end note
}

package "AWS Storage Entities" {
    component "S3 Object Data" as S3ObjectData <<DataEntity>>
    component "DynamoDB Table Data" as DynamoDBTableData <<DataEntity>>

    note right of S3ObjectData
        <b>Attributes</b>
        - object key, bucket, type, size
        - ETag, upload time, permissions
    end note

    note right of DynamoDBTableData
        <b>Attributes</b>
        - table name, partition key, sort key
        - attributes (Map), TTL, GSI
    end note
}

package "Data Relationships" {
    UserData "1" --> "N" PortfolioData : owns
    PortfolioData "1" --> "N" AssetData : contains
    PortfolioData "1" --> "1" RiskMetricsData : assessed by
    PortfolioData "1" --> "0..1" PortfolioOptimizationData : optimized

    UserData "1" --> "N" TransactionData : executes
    PortfolioData "1" --> "N" TransactionData : linked
    AssetData "1" --> "N" TransactionData : involved

    AssetData "1" --> "N" MarketData : linked
    MarketData "1" --> "N" TechnicalIndicatorData : computes

    UserData "1" --> "N" WatchListData : creates
    AssetData "1" --> "0..1" WatchListData : watched

    UserData "1" --> "1" UserPreferenceData : has

    AssetData "1" --> "0..1" BondData : bond props
    BondData "1" --> "N" MarketData : price data

    AssetData "1" --> "0..1" OptionsData : option props
    OptionsData "1" --> "1" AssetData : underlying
    MarketData "1" --> "0..1" OptionsData : pricing input

    AssetData "1" --> "N" StatisticalData : correlation
    StatisticalData "1" --> "1" AssetData : asset1
    StatisticalData "1" --> "1" AssetData : asset2

    AssetData "1" --> "N" ValuationData : valuation result
    MarketData "1" --> "N" ValuationData : valuation input

    PortfolioData "1" --> "0..1" TimescaleDB : persisted (portfolio-analytics)
    TimescaleDB "1" --> "0..1" RedisCache : caches history
    TimescaleDB "1" --> "0..N" KafkaPortfolioEvents : emits events
    MarketData "1" --> "0..N" KafkaQuotesEnriched : publishes enriched quotes

    PortfolioData "1" --> "0..N" S3ObjectData : attachments
    TransactionData "1" --> "0..N" S3ObjectData : receipts
    UserData "1" --> "0..N" DynamoDBTableData : storage
    PortfolioData "1" --> "0..1" DynamoDBTableData : persisted

    MarketData "1" --> "0..N" SparkDataEntity : batch analysis
    TransactionData "1" --> "0..N" FlinkDataEntity : stream analysis
    PortfolioData "1" --> "0..N" HadoopDataEntity : storage
    SparkDataEntity "1" --> "0..1" RiskMetricsData : analysis result
    FlinkDataEntity "1" --> "0..1" MarketData : real-time insights
    HadoopDataEntity "1" --> "0..N" S3ObjectData : file storage
}

package "Data Flows" {
    note right of MarketData
        <b>Sources</b>
        - Real-time market API
        - Historical storage
        - Third-party, Lambda ingestion
    end note

    note right of TransactionData
        <b>Flow</b>
        Transactions --> update portfolio
        --> update positions, risk, DynamoDB, SQS
    end note

    note right of RiskMetricsData
        <b>Inputs</b>
        Portfolio + Market + Statistical data
        --> risk metrics
    end note

    note right of TechnicalIndicatorData
        <b>Flow</b>
        Market data --> indicators
        --> store --> signals
    end note

    note right of PortfolioOptimizationData
        <b>Flow</b>
        Portfolio + Market + Stats
        --> Markowitz --> weights --> store
    end note

    note right of ValuationData
        <b>Flow</b>
        Market + financials
        --> DCF/DDM/relative --> store
    end note

    note right of S3ObjectData
        <b>Flow</b>
        Upload --> S3 --> URL --> DynamoDB metadata
    end note

    note right of DynamoDBTableData
        <b>Flow</b>
        App data --> DynamoDB --> backup, GSI, Lambda
    end note

    note right of SparkDataEntity
        <b>Batch</b>
        Market --> Spark --> DataFrame, SQL
        --> risk metrics --> store
    end note

    note right of FlinkDataEntity
        <b>Stream</b>
        Transactions --> Flink --> DataStream
        --> real-time calc, alerts, checkpoint
    end note

    note right of HadoopDataEntity
        <b>Storage</b>
        Portfolio --> HDFS --> blocks, replicas
        --> analytics, YARN
    end note
}

legend right
    |<#E3F2FD> Data entities | Core business data
    |
    <b>Relations</b>
    --> data dependency
    1..N one-to-many
    0..1 zero-or-one
    |
    <b>Types</b>
    UUID, Decimal, DateTime
endlegend

@enduml
