@startuml c4-mobile-portfolio-components
!include ../../c4-lib/C4-PlantUML/C4_Component.puml

title Mobile Portfolio App - Component Diagram

Container_Boundary(mobile_portfolio, "Mobile Portfolio (Expo + React Native)") {
    Component(tabs_router, "Tabs Router", "Expo Router", "Dashboard, Accounts, Insights, Watchlists, Profile")
    Component(dashboard_screen, "Dashboard Screen", "React Native", "Portfolio summary, native charts, net worth, allocation")
    Component(accounts_screen, "Accounts Screen", "React Native", "Stocks list, real-time quotes, per-stock sparklines, detail drawer")
    Component(insights_screen, "Insights Screen", "React Native", "Risk metrics, server risk-metrics API")
    Component(watchlists_screen, "Watchlists Screen", "React Native", "Watchlists, add-symbol drawer, detail drawer with watchlist options")
    Component(profile_screen, "Profile Screen", "React Native", "User preferences via API")

    Component(types_layer, "types", "TypeScript", "Portfolio, QuoteSnapshot, Watchlist, Instrument, etc.")
    Component(api_client, "portfolioApi", "TypeScript", "GET portfolio (cached), getAccounts, getRiskSummary, seedPortfolio")
    Component(quotes_rest, "getQuotes", "TypeScript", "GET /api/v1/quotes")
    Component(quote_socket, "createQuoteSocket", "TypeScript", "WebSocket /ws/quotes, subscribe, reconnect")
    Component(rest_apis, "customersApi, userPreferencesApi, watchlistsApi, instrumentsApi, riskMetricsApi", "TypeScript", "REST resources")

    Component(redux_quotes, "Redux quotes slice", "Redux Toolkit", "quotes, history, subscribedSymbols, setSnapshot, setStatus")
    Component(quote_subscriber, "QuoteSocketSubscriber", "React Native", "Reads subscribedSymbols, runs WebSocket, dispatches to store")
    Component(portfolio_store, "Portfolio Store", "Custom", "Selected account id (UI)")

    Component(use_symbol_display, "useSymbolDisplayData", "Hook", "setSubscribedSymbols, select from Redux; bySymbol, quoteMap, historyBySymbol")
    Component(use_portfolio, "usePortfolio", "Hook", "portfolio + allocation + history + refresh")
    Component(use_realtime_quotes, "useRealtimeQuotes", "Hook", "Real-time quote subscription (fallback)")
    Component(use_per_symbol_history, "usePerSymbolHistory", "Hook", "Per-symbol price history (used inside store flow)")
    Component(use_draggable_drawer, "useDraggableDrawer", "Hook", "Slide/drag animation for bottom sheets")
    Component(use_watchlists, "useWatchlists", "Hook", "Watchlists, instruments, addItem, removeItem")
    Component(use_user_prefs, "useUserPreferences", "Hook", "Profile preferences")
    Component(use_risk_metrics, "useRiskMetrics", "Hook", "Insights risk-metrics API")

    Component(portfolio_summary, "PortfolioSummary", "React Native", "Net worth, today change")
    Component(asset_allocation_chart, "AssetAllocationChart", "React Native", "Pie by account type")
    Component(net_worth_chart, "NetWorthLineChart", "React Native", "Net worth trend")
    Component(account_list_item, "AccountListItem", "React Native", "Account row")
    Component(stock_list_item, "StockListItem", "React Native", "Holding row, price, sparkline, opens detail drawer")
    Component(holding_list_item, "HoldingListItem", "React Native", "Holding row")
    Component(metric_card, "MetricCard", "React Native", "Label, value, helper")
    Component(sparkline_ui, "Sparkline", "React Native", "JS sparkline")
    Component(native_sparkline, "NativeSparkline", "Native View", "Per-stock sparkline")
    Component(native_line_chart, "NativeLineChart", "Native View", "Metal / OpenGL ES")
    Component(stock_detail_drawer, "StockDetailDrawer", "React Native", "Draggable drawer, live price/chart, watchlist add/remove")
    Component(add_symbol_modal, "AddSymbolModal", "React Native", "Draggable drawer, search, add symbol to watchlist")
    Component(watchlist_card, "WatchlistCard", "React Native", "Watchlist rows, opens detail drawer")
    Component(watchlist_item_row, "WatchlistItemRow", "React Native", "Symbol row, sparkline, price")

    Component(api_config, "API Config", "TypeScript", "EXPO_PUBLIC_PORTFOLIO_API_URL, base URL")
}

Container_Ext(portfolio_api, "Portfolio Analytics API", "REST / WebSocket", "Portfolio, /ws/quotes, watchlists, instruments, risk-metrics")

Rel(tabs_router, dashboard_screen, "Routes to", "")
Rel(tabs_router, accounts_screen, "Routes to", "")
Rel(tabs_router, insights_screen, "Routes to", "")
Rel(tabs_router, watchlists_screen, "Routes to", "")
Rel(tabs_router, profile_screen, "Routes to", "")

Rel(dashboard_screen, use_portfolio, "Uses", "")
Rel(use_portfolio, api_client, "Calls", "")
Rel(dashboard_screen, portfolio_summary, "Uses", "")
Rel(dashboard_screen, asset_allocation_chart, "Uses", "")
Rel(dashboard_screen, net_worth_chart, "Uses", "")
Rel(dashboard_screen, native_line_chart, "Uses", "")
Rel(dashboard_screen, portfolio_store, "Reads", "")

Rel(accounts_screen, api_client, "Calls", "getPortfolio")
Rel(accounts_screen, use_symbol_display, "Uses", "")
Rel(accounts_screen, stock_list_item, "Uses", "")
Rel(accounts_screen, account_list_item, "Uses", "")
Rel(accounts_screen, stock_detail_drawer, "Uses", "")
Rel(accounts_screen, portfolio_store, "Reads", "")

Rel(watchlists_screen, use_watchlists, "Uses", "")
Rel(watchlists_screen, use_symbol_display, "Uses", "")
Rel(watchlists_screen, watchlist_card, "Uses", "")
Rel(watchlists_screen, stock_detail_drawer, "Uses", "")
Rel(watchlists_screen, add_symbol_modal, "Uses", "")

Rel(use_symbol_display, redux_quotes, "Dispatches, selects", "")
Rel(quote_subscriber, redux_quotes, "Dispatches setSnapshot", "")
Rel(quote_subscriber, quote_socket, "Creates", "")
Rel(quote_socket, portfolio_api, "WebSocket", "/ws/quotes")

Rel(insights_screen, api_client, "Calls", "getRiskSummary")
Rel(insights_screen, use_risk_metrics, "Uses", "")
Rel(use_risk_metrics, rest_apis, "Calls", "risk-metrics")
Rel(insights_screen, metric_card, "Uses", "")

Rel(profile_screen, use_user_prefs, "Uses", "")
Rel(use_user_prefs, rest_apis, "Calls", "user-preferences")

Rel(stock_detail_drawer, use_draggable_drawer, "Uses", "")
Rel(stock_detail_drawer, use_realtime_quotes, "Uses", "fallback when no displayData")
Rel(add_symbol_modal, use_draggable_drawer, "Uses", "")
Rel(watchlist_card, watchlist_item_row, "Uses", "")
Rel(stock_list_item, native_sparkline, "Uses", "")
Rel(watchlist_item_row, native_sparkline, "Uses", "")

Rel(api_client, api_config, "Uses", "Base URL")
Rel(api_client, portfolio_api, "HTTP", "GET /api/v1/portfolio")
Rel(rest_apis, api_config, "Uses", "")
Rel(rest_apis, portfolio_api, "HTTP", "REST")
Rel(quotes_rest, api_config, "Uses", "")
Rel(quotes_rest, portfolio_api, "HTTP", "GET /api/v1/quotes")
Rel(api_client, types_layer, "Uses", "")
Rel(quote_socket, types_layer, "Uses", "")

@enduml
