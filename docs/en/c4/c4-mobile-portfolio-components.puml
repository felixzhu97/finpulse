@startuml c4-mobile-portfolio-components
!define RELATIVE_INCLUDE 1
!include ../../c4-lib/C4-PlantUML/C4_Component.puml

title Mobile Portfolio App - Component Diagram (Clean Architecture)

Container_Boundary(mobile_portfolio, "Mobile Portfolio (Expo + React Native)") {
    Component(app_content, "AppContent", "React Native", "Root layout: uses usePreferences().loading, shows spinner until preferences fetched, then renders tabs")
    Component(tabs_router, "Tabs Router", "Expo Router", "Dashboard, Watchlist, Insights, Account, Storybook (dev)")
    Component(overview_screen, "Dashboard Screen", "React Native", "Portfolio summary, native charts, net worth, allocation")
    Component(watchlist_screen, "Watchlist Screen", "React Native", "Stocks list (portfolio), search (bottom), sort, detail drawer")
    Component(analytics_screen, "Insights Screen", "React Native", "Risk metrics (volatility, Sharpe, VaR, beta), computed VaR from portfolio history")
    Component(account_screen, "Account Screen", "React Native", "Profile, account list, Actions; useAccountData loads on tab focus via useFocusEffect")
    Component(storybook_screen, "Storybook Screen", "React Native", "Dev-only /storybook route; wraps StorybookUIRoot with back bar")

    ' Presentation Layer
    Boundary(presentation_layer, "Presentation Layer") {
        Component(portfolio_summary, "PortfolioSummary", "React Native", "Net worth, today change")
        Component(asset_allocation_chart, "AssetAllocationChart", "React Native", "Pie by account type")
        Component(net_worth_chart, "NetWorthLineChart", "React Native", "Net worth trend")
        Component(account_list_item, "AccountListItem", "React Native", "Account row")
        Component(stock_list_item, "StockListItem", "React Native", "Holding row, price, sparkline, opens detail drawer")
        Component(metric_card, "MetricCard", "React Native", "Label, value, helper")
        Component(native_sparkline, "NativeSparkline", "Native View", "Per-stock sparkline")
        Component(stock_detail_drawer, "StockDetailDrawer", "React Native", "Draggable drawer, setExtraSubscribedSymbols, Redux quotes, share")
        Component(account_drawers, "Account Drawers", "React Native", "RegisterCustomerDrawer, NewPaymentDrawer, NewTradeDrawer, SettingsDrawer")
        Component(sort_menu, "SortMenu", "React Native", "Sort by name, price, change, change %")
        Component(glass_search_bar, "Bottom search bar", "React Native", "GlassView, opens on search icon")
        Component(glass_view, "GlassView", "React Native", "expo-blur, Liquid Glass")
        
        Component(use_portfolio_hook, "usePortfolio", "Hook", "Portfolio data via useAsyncLoad")
        Component(use_account_data_hook, "useAccountData", "Hook", "Customer, accounts, accountResources on focus")
        Component(use_symbol_display_hook, "useSymbolDisplayData", "Hook", "Redux-backed quotes + history")
        Component(use_refresh_control_hook, "useRefreshControl", "Hook", "Pull-to-refresh pattern")
        Component(use_draggable_drawer_hook, "useDraggableDrawer", "Hook", "Slide/drag animation")
        Component(use_preferences_hook, "usePreferences", "Hook", "Redux-backed user preferences")
        Component(use_theme_hook, "useTheme", "Hook", "Current theme colors")
        Component(use_risk_metrics_hook, "useRiskMetrics", "Hook", "Risk metrics API")
        Component(use_risk_summary_hook, "useRiskSummary", "Hook", "Risk summary (high-risk ratio, top holdings concentration)")
        Component(use_computed_var_hook, "useComputedVar", "Hook", "VaR computation")
        
        Component(redux_quotes, "Redux quotes slice", "Redux Toolkit", "quotes, history, subscribedSymbols, extraSubscribedSymbols")
        Component(redux_preferences, "Redux preferences slice", "Redux Toolkit", "theme, language, notifications")
        Component(quote_subscriber, "QuoteSocketSubscriber", "React Native", "Subscribes to merged symbols")
        Component(redux_portfolio, "Redux portfolio slice", "Redux Toolkit", "selectedAccountId")
        
        Component(theme_system, "Theme System", "TypeScript", "Light/dark colors; styles/useTheme.ts")
        Component(styled_theme_provider, "StyledThemeProvider", "styled-components/native", "Injects theme (colors) from useTheme into styled-components")
        Component(theme_primitives, "Theme Primitives", "styled-components/native", "ScreenRoot, ListRow, CardBordered, LabelText, ValueText, withTheme")
        Component(i18n_config, "i18n Config", "TypeScript", "i18next setup, translations")
        Component(use_translation, "useTranslation", "Hook", "Translation hook")
        Component(period_data_processor, "PeriodDataProcessor", "TypeScript", "lib/utils: period filtering")
        Component(storybook_ui_root, "StorybookUIRoot", "Storybook React Native", "On-device catalog of native and RN components")
    }

    ' Application Layer
    Boundary(application_layer, "Application Layer") {
        Component(dependency_container, "DependencyContainer", "TypeScript", "Dependency injection container")
        Component(get_portfolio_usecase, "GetPortfolioUseCase", "TypeScript", "Portfolio use case")
        Component(get_customer_usecase, "GetCustomerUseCase", "TypeScript", "Customer use case")
        Component(get_quotes_usecase, "GetQuotesUseCase", "TypeScript", "Quotes use case")
        Component(risk_metrics_usecase, "RiskMetricsUseCase", "TypeScript", "Risk metrics, risk summary, VaR computation")
    }

    ' Domain Layer
    Boundary(domain_layer, "Domain Layer") {
        Component(domain_entities, "Domain Entities", "TypeScript", "Portfolio, Quote, Customer, etc.")
        Component(portfolio_repo_interface, "IPortfolioRepository", "TypeScript", "Portfolio repository interface")
        Component(quote_repo_interface, "IQuoteRepository", "TypeScript", "Quote repository interface")
        Component(customer_repo_interface, "ICustomerRepository", "TypeScript", "Customer repository interface")
        Component(other_repo_interfaces, "Other Repository Interfaces", "TypeScript", "UserPreference, Watchlist, Instrument, etc.")
    }

    ' Infrastructure Layer (lib/api/client, lib/api/endpoints, lib/utils)
    Boundary(infrastructure_layer, "Infrastructure Layer") {
        Component(http_client, "HttpClient", "TypeScript", "lib/api/client: HTTP client wrapper")
        Component(quote_socket, "createQuoteSocket", "TypeScript", "lib/api/client: WebSocket /ws/quotes")
        Component(api_config, "API Config", "TypeScript", "lib/api/client: EXPO_PUBLIC_PORTFOLIO_API_URL")
        
        Component(portfolio_repo_impl, "PortfolioRepository", "TypeScript", "lib/api/endpoints: implements IPortfolioRepository (thin client; delegates to API)")
        Component(quote_repo_impl, "QuoteRepository", "TypeScript", "lib/api/endpoints: IQuoteRepository")
        Component(customer_repo_impl, "CustomerRepository", "TypeScript", "lib/api/endpoints: ICustomerRepository")
        Component(other_repo_impls, "Other Repositories", "TypeScript", "lib/api/endpoints: UserPreference, Watchlist, etc.")
        
        Component(web3_service, "web3Service", "TypeScript", "Web3 integration")
        Component(utils, "Utils", "TypeScript", "lib/utils")
    }

    ' Native Components
    Boundary(native_layer, "Native Components") {
        Component(base_chart_view_manager, "BaseChartViewManager", "Native Base Class", "Abstract RCTViewManager")
        Component(base_chart_view, "BaseChartView", "Native Base Class", "Abstract UIView with Metal")
        Component(base_chart_renderer, "BaseChartRenderer", "Native Base Class", "Abstract Metal renderer")
        Component(native_line_chart, "NativeLineChart", "Native View", "Metal / OpenGL ES chart")
    }
}

Container_Ext(portfolio_api, "Portfolio Analytics API", "REST / WebSocket", "Portfolio, /ws/quotes, customers, accounts, payments, orders, trades, risk-metrics")

' Presentation to Application
Rel(use_portfolio_hook, dependency_container, "Gets use case", "")
Rel(use_symbol_display_hook, dependency_container, "Gets repository", "")
Rel(use_preferences_hook, dependency_container, "Gets repository", "")
Rel(use_risk_metrics_hook, dependency_container, "Gets use case", "")
Rel(use_risk_summary_hook, dependency_container, "Gets use case", "")
Rel(use_computed_var_hook, dependency_container, "Gets use case", "")
Rel(use_account_data_hook, dependency_container, "Gets use case", "")

' Application to Domain
Rel(dependency_container, get_portfolio_usecase, "Provides", "")
Rel(dependency_container, get_customer_usecase, "Provides", "")
Rel(dependency_container, get_quotes_usecase, "Provides", "")
Rel(dependency_container, risk_metrics_usecase, "Provides", "")
Rel(get_portfolio_usecase, portfolio_repo_interface, "Uses", "")
Rel(get_customer_usecase, customer_repo_interface, "Uses", "")
Rel(get_quotes_usecase, quote_repo_interface, "Uses", "")
Rel(risk_metrics_usecase, portfolio_repo_interface, "Uses", "")

' Infrastructure implements Domain
Rel(portfolio_repo_impl, portfolio_repo_interface, "Implements", "")
Rel(quote_repo_impl, quote_repo_interface, "Implements", "")
Rel(customer_repo_impl, customer_repo_interface, "Implements", "")
Rel(other_repo_impls, other_repo_interfaces, "Implements", "")

' Application uses Infrastructure
Rel(dependency_container, portfolio_repo_impl, "Provides", "")
Rel(dependency_container, quote_repo_impl, "Provides", "")
Rel(dependency_container, customer_repo_impl, "Provides", "")
Rel(dependency_container, other_repo_impls, "Provides", "")

' Infrastructure to External API
Rel(portfolio_repo_impl, http_client, "Uses", "")
Rel(quote_repo_impl, http_client, "Uses", "")
Rel(customer_repo_impl, http_client, "Uses", "")
Rel(http_client, api_config, "Uses", "")
Rel(http_client, portfolio_api, "HTTP", "")
Rel(quote_socket, portfolio_api, "WebSocket", "/ws/quotes")

' Presentation UI
Rel(app_content, use_preferences_hook, "Uses", "")
Rel(app_content, tabs_router, "Renders", "")
Rel(tabs_router, overview_screen, "Routes to", "")
Rel(tabs_router, watchlist_screen, "Routes to", "")
Rel(tabs_router, analytics_screen, "Routes to", "")
Rel(tabs_router, account_screen, "Routes to", "")
Rel(tabs_router, storybook_screen, "Routes to (dev)", "")

Rel(overview_screen, use_portfolio_hook, "Uses", "")
Rel(overview_screen, use_refresh_control_hook, "Uses", "")
Rel(overview_screen, portfolio_summary, "Uses", "")
Rel(overview_screen, asset_allocation_chart, "Uses", "")
Rel(overview_screen, net_worth_chart, "Uses", "")
Rel(overview_screen, native_line_chart, "Uses", "")

Rel(watchlist_screen, use_portfolio_hook, "Uses", "")
Rel(watchlist_screen, use_symbol_display_hook, "Uses", "")
Rel(watchlist_screen, use_refresh_control_hook, "Uses", "")
Rel(watchlist_screen, stock_list_item, "Uses", "")
Rel(watchlist_screen, account_list_item, "Uses", "")
Rel(watchlist_screen, stock_detail_drawer, "Uses", "")
Rel(watchlist_screen, sort_menu, "Uses", "")
Rel(watchlist_screen, glass_search_bar, "Uses", "")

Rel(analytics_screen, use_risk_metrics_hook, "Uses", "")
Rel(analytics_screen, use_risk_summary_hook, "Uses", "")
Rel(analytics_screen, use_refresh_control_hook, "Uses", "")
Rel(analytics_screen, use_computed_var_hook, "Uses", "")
Rel(analytics_screen, metric_card, "Uses", "")

Rel(account_screen, use_account_data_hook, "Uses", "")
Rel(account_screen, use_refresh_control_hook, "Uses", "")
Rel(account_screen, account_drawers, "Uses", "")
Rel(account_screen, use_preferences_hook, "Uses", "")
Rel(account_screen, storybook_screen, "Navigates to (dev Storybook entry)", "")

' Redux and State
Rel(use_symbol_display_hook, redux_quotes, "Dispatches, selects", "")
Rel(quote_subscriber, redux_quotes, "Dispatches", "")
Rel(quote_subscriber, quote_socket, "Creates", "")
Rel(use_preferences_hook, redux_preferences, "Dispatches, selects", "")

' Theme and i18n
Rel(overview_screen, use_theme_hook, "Uses", "")
Rel(watchlist_screen, use_theme_hook, "Uses", "")
Rel(analytics_screen, use_theme_hook, "Uses", "")
Rel(account_screen, use_theme_hook, "Uses", "")
Rel(app_content, styled_theme_provider, "Wraps", "")
Rel(styled_theme_provider, use_theme_hook, "Uses", "")
Rel(use_theme_hook, theme_system, "Uses", "")
Rel(use_theme_hook, redux_preferences, "Reads", "")
Rel(metric_card, theme_primitives, "Uses", "")
Rel(account_drawers, theme_primitives, "Uses", "")
Rel(theme_primitives, styled_theme_provider, "Receives theme from", "")

Rel(overview_screen, use_translation, "Uses", "")
Rel(watchlist_screen, use_translation, "Uses", "")
Rel(analytics_screen, use_translation, "Uses", "")
Rel(account_screen, use_translation, "Uses", "")
Rel(use_translation, i18n_config, "Uses", "")

' Native charts
Rel(native_line_chart, base_chart_view, "Inherits from", "")
Rel(native_line_chart, base_chart_renderer, "Uses", "")
Rel(base_chart_view_manager, base_chart_view, "Creates", "")
Rel(stock_detail_drawer, period_data_processor, "Uses", "")
Rel(storybook_screen, storybook_ui_root, "Renders", "")

' Domain entities
Rel(portfolio_repo_interface, domain_entities, "Returns", "")
Rel(quote_repo_interface, domain_entities, "Returns", "")
Rel(customer_repo_interface, domain_entities, "Returns", "")

LAYOUT_TOP_DOWN()

@enduml
