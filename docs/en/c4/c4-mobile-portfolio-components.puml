@startuml c4-mobile-portfolio-components
!define RELATIVE_INCLUDE 1
!include ../../c4-lib/C4-PlantUML/C4_Component.puml

title Mobile Portfolio App - Component Diagram

Container_Boundary(mobile_portfolio, "Mobile Portfolio (Expo + React Native)") {
    Component(app_content, "AppContent", "React Native", "Root layout: uses usePreferences().loading, shows spinner until preferences fetched, then renders tabs")
    Component(tabs_router, "Tabs Router", "Expo Router", "Dashboard, Watchlist, Insights, Account")
    Component(overview_screen, "Dashboard Screen", "React Native", "Portfolio summary, native charts, net worth, allocation")
    Component(watchlist_screen, "Watchlist Screen", "React Native", "Stocks list (portfolio), search (bottom), sort, detail drawer")
    Component(analytics_screen, "Insights Screen", "React Native", "Risk metrics (volatility, Sharpe, VaR, beta), computed VaR from portfolio history")
    Component(account_screen, "Account Screen", "React Native", "Profile, account list, Actions (Register, New Payment, New Trade, Settings); useFocusEffect loads data on tab focus")

    Component(types_layer, "types", "TypeScript", "Portfolio, QuoteSnapshot, Instrument, etc.")
    Component(api_client, "portfolioApi", "TypeScript", "GET portfolio (cached), getAccounts, getRiskSummary, seedPortfolio")
    Component(quotes_rest, "getQuotes", "TypeScript", "GET /api/v1/quotes")
    Component(quote_socket, "createQuoteSocket", "TypeScript", "WebSocket /ws/quotes, subscribe, reconnect")
    Component(rest_apis, "customersApi, accountsApi, paymentsApi, tradesApi, ordersApi, userPreferencesApi, riskMetricsApi", "TypeScript", "REST: Profile, Actions (register, payment, trade), Settings, Analytics, VaR compute")

    Component(redux_quotes, "Redux quotes slice", "Redux Toolkit", "quotes, history, subscribedSymbols, setSnapshot, setStatus")
    Component(redux_preferences, "Redux preferences slice", "Redux Toolkit", "theme, language, notificationsEnabled, setTheme, setLanguage, setNotificationsEnabled")
    Component(quote_subscriber, "QuoteSocketSubscriber", "React Native", "Reads subscribedSymbols, runs WebSocket, dispatches to store")
    Component(portfolio_store, "Portfolio Store", "Custom", "Selected account id (UI)")

    Component(use_symbol_display, "useSymbolDisplayData", "Hook", "setSubscribedSymbols, select from Redux; bySymbol, quoteMap, historyBySymbol")
    Component(use_portfolio, "usePortfolio", "Hook", "portfolio + allocation + history + refresh")
    Component(use_draggable_drawer, "useDraggableDrawer", "Hook", "Slide/drag animation for bottom sheets")
    Component(use_preferences, "usePreferences", "Hook", "Redux-backed user preferences (theme, language, notifications); provides loading (component-level, from useUserPreferences)")
    Component(use_theme, "useTheme", "Hook", "Current theme colors (light/dark) based on preferences and system")
    Component(use_risk_metrics, "useRiskMetrics", "Hook", "Insights risk-metrics API")
    Component(use_computed_var, "useComputedVar", "Hook", "POST risk-metrics/compute for VaR from portfolio history")

    Component(portfolio_summary, "PortfolioSummary", "React Native", "Net worth, today change")
    Component(asset_allocation_chart, "AssetAllocationChart", "React Native", "Pie by account type")
    Component(net_worth_chart, "NetWorthLineChart", "React Native", "Net worth trend")
    Component(account_list_item, "AccountListItem", "React Native", "Account row")
    Component(stock_list_item, "StockListItem", "React Native", "Holding row, price, sparkline, opens detail drawer")
    Component(metric_card, "MetricCard", "React Native", "Label, value, helper")
    Component(native_sparkline, "NativeSparkline", "Native View", "Per-stock sparkline")
    Component(native_line_chart, "NativeLineChart", "Native View", "Metal / OpenGL ES, OOP helpers (ChartLayoutCalculator, ValueFormatter, AxisLabelManager, ChartRenderer)")
    Component(period_data_processor, "PeriodDataProcessor", "TypeScript", "OOP class for period data filtering and volume matching")
    Component(stock_detail_drawer, "StockDetailDrawer", "React Native", "Draggable drawer, live price/chart, share, simplified logic")
    Component(account_drawers, "Account Drawers", "React Native", "RegisterCustomerDrawer, NewPaymentDrawer, NewTradeDrawer, SettingsDrawer (useDraggableDrawer, colors.card)")
    Component(sort_menu, "SortMenu", "React Native", "Sort by name, price, change, change %")
    Component(glass_search_bar, "Bottom search bar", "React Native", "GlassView, opens on search icon, closes on drawer/sort/tab")
    Component(glass_view, "GlassView", "React Native", "expo-blur, Liquid Glass for search bar and tab bar")

    Component(api_config, "API Config", "TypeScript", "EXPO_PUBLIC_PORTFOLIO_API_URL, base URL")
    Component(theme_system, "Theme System", "TypeScript", "Light/dark color schemes, useTheme hook")
    Component(i18n_config, "i18n Config", "TypeScript", "i18next setup, translation resources (en, zh)")
    Component(use_translation, "useTranslation", "Hook", "Access translated strings from i18next")
}

Container_Ext(portfolio_api, "Portfolio Analytics API", "REST / WebSocket", "Portfolio, /ws/quotes, customers, accounts, payments, orders, trades, risk-metrics, risk-metrics/compute")

Rel(app_content, use_preferences, "Uses", "loading, theme sync")
Rel(app_content, tabs_router, "Renders", "")
Rel(tabs_router, overview_screen, "Routes to", "")
Rel(tabs_router, watchlist_screen, "Routes to", "")
Rel(tabs_router, analytics_screen, "Routes to", "")
Rel(tabs_router, account_screen, "Routes to", "")

Rel(overview_screen, use_portfolio, "Uses", "")
Rel(use_portfolio, api_client, "Calls", "")
Rel(overview_screen, portfolio_summary, "Uses", "")
Rel(overview_screen, asset_allocation_chart, "Uses", "")
Rel(overview_screen, net_worth_chart, "Uses", "")
Rel(overview_screen, native_line_chart, "Uses", "")
Rel(overview_screen, portfolio_store, "Reads", "")

Rel(watchlist_screen, api_client, "Calls", "getPortfolio")
Rel(watchlist_screen, use_symbol_display, "Uses", "")
Rel(watchlist_screen, stock_list_item, "Uses", "")
Rel(watchlist_screen, account_list_item, "Uses", "")
Rel(watchlist_screen, stock_detail_drawer, "Uses", "")
Rel(watchlist_screen, sort_menu, "Uses", "")
Rel(watchlist_screen, glass_search_bar, "Uses", "")
Rel(glass_search_bar, glass_view, "Uses", "")

Rel(use_symbol_display, redux_quotes, "Dispatches, selects", "")
Rel(quote_subscriber, redux_quotes, "Dispatches setSnapshot", "")
Rel(quote_subscriber, quote_socket, "Creates", "")
Rel(quote_socket, portfolio_api, "WebSocket", "/ws/quotes")

Rel(analytics_screen, use_risk_metrics, "Uses", "")
Rel(analytics_screen, use_computed_var, "Uses", "")
Rel(use_risk_metrics, rest_apis, "Calls", "risk-metrics")
Rel(use_computed_var, rest_apis, "Calls", "risk-metrics/compute")
Rel(analytics_screen, metric_card, "Uses", "")

Rel(account_screen, account_drawers, "Uses", "")
Rel(account_screen, use_preferences, "Uses", "")
Rel(account_screen, rest_apis, "Calls", "customers (Profile)")
Rel(account_drawers, use_draggable_drawer, "Uses", "")
Rel(account_drawers, rest_apis, "Calls", "customers, accounts, payments, orders, trades, user-preferences")
Rel(use_preferences, redux_preferences, "Dispatches, selects", "")
Rel(use_preferences, rest_apis, "Calls", "user-preferences (Settings)")
Rel(overview_screen, use_theme, "Uses", "")
Rel(watchlist_screen, use_theme, "Uses", "")
Rel(analytics_screen, use_theme, "Uses", "")
Rel(account_screen, use_theme, "Uses", "")
Rel(use_theme, theme_system, "Uses", "")
Rel(use_theme, redux_preferences, "Reads", "theme preference")

Rel(overview_screen, use_translation, "Uses", "")
Rel(watchlist_screen, use_translation, "Uses", "")
Rel(analytics_screen, use_translation, "Uses", "")
Rel(account_screen, use_translation, "Uses", "")
Rel(sort_menu, use_translation, "Uses", "")
Rel(use_preferences, use_translation, "Syncs", "language change")
Rel(use_translation, i18n_config, "Uses", "")
Rel(use_translation, redux_preferences, "Reads", "language preference")

Rel(stock_detail_drawer, use_draggable_drawer, "Uses", "")
Rel(stock_detail_drawer, period_data_processor, "Uses", "Period filtering")
Rel(stock_list_item, native_sparkline, "Uses", "")

Rel(api_client, api_config, "Uses", "Base URL")
Rel(api_client, portfolio_api, "HTTP", "GET /api/v1/portfolio")
Rel(rest_apis, api_config, "Uses", "")
Rel(rest_apis, portfolio_api, "HTTP", "REST")
Rel(quotes_rest, api_config, "Uses", "")
Rel(quotes_rest, portfolio_api, "HTTP", "GET /api/v1/quotes")
Rel(api_client, types_layer, "Uses", "")
Rel(quote_socket, types_layer, "Uses", "")

@enduml
