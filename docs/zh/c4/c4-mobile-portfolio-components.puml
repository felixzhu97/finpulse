@startuml c4-mobile-portfolio-components-zh
!define RELATIVE_INCLUDE 1
!include ../../c4-lib/C4-PlantUML/C4_Component.puml

title 移动端投资组合应用 - 组件图（整洁架构）

Container_Boundary(mobile_portfolio, "移动端投资组合 (Expo + React Native)") {
    Component(app_content, "AppContent", "React Native", "根布局：使用 usePreferences().loading，偏好加载完成前显示 spinner，随后渲染标签")
    Component(tabs_router, "标签路由", "Expo Router", "仪表板、自选、洞察、账户、Storybook（开发）")
    Component(overview_screen, "仪表板屏幕", "React Native", "组合摘要、原生图表、净资产、资产配置")
    Component(watchlist_screen, "自选屏幕", "React Native", "股票列表（组合）、底部搜索、排序、详情抽屉")
    Component(analytics_screen, "洞察屏幕", "React Native", "风险指标（波动率、夏普比率、VaR、Beta）、根据组合历史计算的 VaR")
    Component(account_screen, "账户屏幕", "React Native", "个人资料、账户列表、操作；useAccountData 在标签聚焦时加载")
    Component(storybook_screen, "Storybook 屏幕", "React Native", "仅开发环境的 /storybook 路由；包裹 StorybookUIRoot 并提供返回栏")

    ' Presentation Layer
    Boundary(presentation_layer, "展示层") {
        Component(portfolio_summary, "PortfolioSummary", "React Native", "净资产、当日变动")
        Component(asset_allocation_chart, "AssetAllocationChart", "React Native", "按账户类型饼图")
        Component(net_worth_chart, "NetWorthLineChart", "React Native", "净资产趋势")
        Component(account_list_item, "AccountListItem", "React Native", "账户行")
        Component(stock_list_item, "StockListItem", "React Native", "持仓行、价格、迷你图、打开详情抽屉")
        Component(metric_card, "MetricCard", "React Native", "标签、数值、说明")
        Component(native_sparkline, "NativeSparkline", "原生视图", "每股迷你图")
        Component(stock_detail_drawer, "StockDetailDrawer", "React Native", "可拖拽抽屉、setExtraSubscribedSymbols、Redux 报价、分享")
        Component(account_drawers, "账户抽屉", "React Native", "RegisterCustomerDrawer、NewPaymentDrawer、NewTradeDrawer、SettingsDrawer")
        Component(sort_menu, "SortMenu", "React Native", "按名称、价格、涨跌、涨跌幅排序")
        Component(glass_search_bar, "底部搜索栏", "React Native", "GlassView，点击搜索图标打开")
        Component(glass_view, "GlassView", "React Native", "expo-blur，Liquid Glass")
        
        Component(use_portfolio_hook, "usePortfolio", "Hook", "组合数据 via useAsyncLoad")
        Component(use_account_data_hook, "useAccountData", "Hook", "客户、账户、账户资源，聚焦时加载")
        Component(use_symbol_display_hook, "useSymbolDisplayData", "Hook", "Redux 管理的报价和历史")
        Component(use_refresh_control_hook, "useRefreshControl", "Hook", "下拉刷新模式")
        Component(use_draggable_drawer_hook, "useDraggableDrawer", "Hook", "滑动/拖拽动画")
        Component(use_preferences_hook, "usePreferences", "Hook", "Redux 管理的用户偏好")
        Component(use_theme_hook, "useTheme", "Hook", "当前主题颜色")
        Component(use_risk_metrics_hook, "useRiskMetrics", "Hook", "风险指标 API")
        Component(use_risk_summary_hook, "useRiskSummary", "Hook", "风险摘要（高风险持仓占比、前五大持仓集中度）")
        Component(use_computed_var_hook, "useComputedVar", "Hook", "VaR 计算")
        
        Component(redux_quotes, "Redux quotes slice", "Redux Toolkit", "quotes、history、subscribedSymbols、extraSubscribedSymbols")
        Component(redux_preferences, "Redux preferences slice", "Redux Toolkit", "theme、language、notifications")
        Component(quote_subscriber, "QuoteSocketSubscriber", "React Native", "订阅合并符号")
        Component(redux_portfolio, "Redux portfolio slice", "Redux Toolkit", "selectedAccountId")
        
        Component(theme_system, "主题系统", "TypeScript", "浅色/深色配色；useTheme (useTheme.ts)")
        Component(styled_theme_provider, "StyledThemeProvider", "styled-components/native", "从 useTheme 注入 theme (colors) 到 styled-components")
        Component(theme_primitives, "主题基元", "styled-components/native", "ScreenRoot、ListRow、CardBordered、LabelText、ValueText、withTheme")
        Component(i18n_config, "i18n 配置", "TypeScript", "i18next 设置、翻译资源")
        Component(use_translation, "useTranslation", "Hook", "翻译 Hook")
        Component(period_data_processor, "PeriodDataProcessor", "TypeScript", "presentation/utils 周期过滤")
        Component(storybook_ui_root, "StorybookUIRoot", "Storybook React Native", "原生组件和 React Native 组件的设备端目录")
    }

    ' Domain Layer
    Boundary(domain_layer, "领域层") {
        Component(domain_entities, "领域实体", "TypeScript", "Portfolio、Quote、Customer 等")
        Component(domain_dto, "领域 DTO", "TypeScript", "WatchlistWithItems、UpdatePreferenceInput、AccountDataResult、RegisterCustomerInput")
    }

    ' Infrastructure Layer
    Boundary(infrastructure_layer, "基础设施层") {
        Component(api_module, "API 模块", "TypeScript", "按领域：portfolio、market、account、risk、blockchain。getPortfolioData、getQuotes、getWatchlists、getAccountData、getRiskMetrics、getBlockchainBalance 等")
        Component(http_client, "HttpClient", "TypeScript", "HTTP 客户端包装器")
        Component(quote_socket, "createQuoteSocket", "TypeScript", "WebSocket /ws/quotes")
        Component(api_config, "API Config", "TypeScript", "EXPO_PUBLIC_PORTFOLIO_API_URL")
        Component(quote_stream_service, "quoteStreamService", "TypeScript", "QuoteStreamService：subscribe(symbols)，使用 quoteStreamTypes")
        Component(web3_service, "web3Service", "TypeScript", "Web3 集成")
    }

    ' Native Components
    Boundary(native_layer, "原生组件") {
        Component(base_chart_view_manager, "BaseChartViewManager", "原生基类", "抽象 RCTViewManager")
        Component(base_chart_view, "BaseChartView", "原生基类", "抽象 UIView，包含 Metal")
        Component(base_chart_renderer, "BaseChartRenderer", "原生基类", "抽象 Metal 渲染器")
        Component(native_line_chart, "NativeLineChart", "原生视图", "Metal / OpenGL ES 图表")
    }
}

Container_Ext(portfolio_api, "投资组合分析 API", "REST / WebSocket", "组合、/ws/quotes、customers、accounts、payments、orders、trades、risk-metrics")

' Presentation to Infrastructure (API and services)
Rel(use_portfolio_hook, api_module, "调用 getPortfolioData", "")
Rel(use_account_data_hook, api_module, "调用 getAccountData", "")
Rel(use_symbol_display_hook, api_module, "调用 getQuotes、getQuotesHistory", "")
Rel(use_preferences_hook, api_module, "调用 getUserPreference、updateUserPreference", "")
Rel(use_risk_metrics_hook, api_module, "调用 getRiskMetrics", "")
Rel(use_risk_summary_hook, api_module, "调用 getRiskSummary", "")
Rel(use_computed_var_hook, api_module, "调用 computeVar", "")
Rel(account_drawers, api_module, "调用 registerCustomer、createPayment、getTradeFormData、createOrder、executeTrade", "")

Rel(quote_subscriber, quote_stream_service, "使用 subscribe()", "")
Rel(quote_stream_service, quote_socket, "使用 createQuoteSocket", "")
Rel(quote_socket, portfolio_api, "WebSocket", "/ws/quotes")

' API module to HTTP and Domain
Rel(api_module, http_client, "使用", "")
Rel(api_module, domain_entities, "使用类型", "")
Rel(api_module, domain_dto, "使用类型", "")
Rel(http_client, api_config, "使用", "")
Rel(http_client, portfolio_api, "HTTP", "")

' Presentation UI
Rel(app_content, use_preferences_hook, "使用", "")
Rel(app_content, tabs_router, "渲染", "")
Rel(tabs_router, overview_screen, "路由到", "")
Rel(tabs_router, watchlist_screen, "路由到", "")
Rel(tabs_router, analytics_screen, "路由到", "")
Rel(tabs_router, account_screen, "路由到", "")
Rel(tabs_router, storybook_screen, "路由到（开发）", "")

Rel(overview_screen, use_portfolio_hook, "使用", "")
Rel(overview_screen, use_refresh_control_hook, "使用", "")
Rel(overview_screen, portfolio_summary, "使用", "")
Rel(overview_screen, asset_allocation_chart, "使用", "")
Rel(overview_screen, net_worth_chart, "使用", "")
Rel(overview_screen, native_line_chart, "使用", "")

Rel(watchlist_screen, use_portfolio_hook, "使用", "")
Rel(watchlist_screen, use_symbol_display_hook, "使用", "")
Rel(watchlist_screen, use_refresh_control_hook, "使用", "")
Rel(watchlist_screen, stock_list_item, "使用", "")
Rel(watchlist_screen, account_list_item, "使用", "")
Rel(watchlist_screen, stock_detail_drawer, "使用", "")
Rel(watchlist_screen, sort_menu, "使用", "")
Rel(watchlist_screen, glass_search_bar, "使用", "")

Rel(analytics_screen, use_risk_metrics_hook, "使用", "")
Rel(analytics_screen, use_risk_summary_hook, "使用", "")
Rel(analytics_screen, use_refresh_control_hook, "使用", "")
Rel(analytics_screen, use_computed_var_hook, "使用", "")
Rel(analytics_screen, metric_card, "使用", "")

Rel(account_screen, use_account_data_hook, "使用", "")
Rel(account_screen, use_refresh_control_hook, "使用", "")
Rel(account_screen, account_drawers, "使用", "")
Rel(account_screen, use_preferences_hook, "使用", "")
Rel(account_screen, storybook_screen, "跳转到（开发 Storybook 入口）", "")

' Redux and State
Rel(use_symbol_display_hook, redux_quotes, "派发、选择", "")
Rel(quote_subscriber, redux_quotes, "派发", "")
Rel(quote_subscriber, quote_socket, "创建", "")
Rel(use_preferences_hook, redux_preferences, "派发、选择", "")

' Theme and i18n
Rel(overview_screen, use_theme_hook, "使用", "")
Rel(watchlist_screen, use_theme_hook, "使用", "")
Rel(analytics_screen, use_theme_hook, "使用", "")
Rel(account_screen, use_theme_hook, "使用", "")
Rel(app_content, styled_theme_provider, "包裹", "")
Rel(styled_theme_provider, use_theme_hook, "使用", "")
Rel(use_theme_hook, theme_system, "使用", "")
Rel(use_theme_hook, redux_preferences, "读取", "")
Rel(metric_card, theme_primitives, "使用", "")
Rel(account_drawers, theme_primitives, "使用", "")
Rel(theme_primitives, styled_theme_provider, "从…接收 theme", "")

Rel(overview_screen, use_translation, "使用", "")
Rel(watchlist_screen, use_translation, "使用", "")
Rel(analytics_screen, use_translation, "使用", "")
Rel(account_screen, use_translation, "使用", "")
Rel(use_translation, i18n_config, "使用", "")

' Native charts
Rel(native_line_chart, base_chart_view, "继承自", "")
Rel(native_line_chart, base_chart_renderer, "使用", "")
Rel(base_chart_view_manager, base_chart_view, "创建", "")
Rel(stock_detail_drawer, period_data_processor, "使用", "")
Rel(storybook_screen, storybook_ui_root, "渲染", "")


LAYOUT_TOP_DOWN()

@enduml
