@startuml c4-mobile-portfolio-components-zh
!define RELATIVE_INCLUDE 1
!include ../../c4-lib/C4-PlantUML/C4_Component.puml

title 移动端投资组合应用 - 组件图（整洁架构）

Container_Boundary(mobile_portfolio, "移动端投资组合 (Expo + React Native)") {
    Component(app_content, "AppContent", "React Native", "根布局：使用 usePreferences().loading，偏好加载完成前显示 spinner，随后渲染标签")
    Component(tabs_router, "标签路由", "Expo Router", "仪表板、自选、洞察、账户")
    Component(overview_screen, "仪表板屏幕", "React Native", "组合摘要、原生图表、净资产、资产配置")
    Component(watchlist_screen, "自选屏幕", "React Native", "股票列表（组合）、底部搜索、排序、详情抽屉")
    Component(analytics_screen, "洞察屏幕", "React Native", "风险指标（波动率、夏普比率、VaR、Beta）、根据组合历史计算的 VaR")
    Component(account_screen, "账户屏幕", "React Native", "个人资料、账户列表、操作；useAccountData 在标签聚焦时加载")

    ' Presentation Layer
    Boundary(presentation_layer, "展示层") {
        Component(portfolio_summary, "PortfolioSummary", "React Native", "净资产、当日变动")
        Component(asset_allocation_chart, "AssetAllocationChart", "React Native", "按账户类型饼图")
        Component(net_worth_chart, "NetWorthLineChart", "React Native", "净资产趋势")
        Component(account_list_item, "AccountListItem", "React Native", "账户行")
        Component(stock_list_item, "StockListItem", "React Native", "持仓行、价格、迷你图、打开详情抽屉")
        Component(metric_card, "MetricCard", "React Native", "标签、数值、说明")
        Component(native_sparkline, "NativeSparkline", "原生视图", "每股迷你图")
        Component(stock_detail_drawer, "StockDetailDrawer", "React Native", "可拖拽抽屉、setExtraSubscribedSymbols、Redux 报价、分享")
        Component(account_drawers, "账户抽屉", "React Native", "RegisterCustomerDrawer、NewPaymentDrawer、NewTradeDrawer、SettingsDrawer")
        Component(sort_menu, "SortMenu", "React Native", "按名称、价格、涨跌、涨跌幅排序")
        Component(glass_search_bar, "底部搜索栏", "React Native", "GlassView，点击搜索图标打开")
        Component(glass_view, "GlassView", "React Native", "expo-blur，Liquid Glass")
        
        Component(use_portfolio_hook, "usePortfolio", "Hook", "组合数据 via useAsyncLoad")
        Component(use_account_data_hook, "useAccountData", "Hook", "客户、账户、账户资源，聚焦时加载")
        Component(use_symbol_display_hook, "useSymbolDisplayData", "Hook", "Redux 管理的报价和历史")
        Component(use_refresh_control_hook, "useRefreshControl", "Hook", "下拉刷新模式")
        Component(use_draggable_drawer_hook, "useDraggableDrawer", "Hook", "滑动/拖拽动画")
        Component(use_preferences_hook, "usePreferences", "Hook", "Redux 管理的用户偏好")
        Component(use_theme_hook, "useTheme", "Hook", "当前主题颜色")
        Component(use_risk_metrics_hook, "useRiskMetrics", "Hook", "风险指标 API")
        Component(use_risk_summary_hook, "useRiskSummary", "Hook", "风险摘要（高风险持仓占比、前五大持仓集中度）")
        Component(use_computed_var_hook, "useComputedVar", "Hook", "VaR 计算")
        
        Component(redux_quotes, "Redux quotes slice", "Redux Toolkit", "quotes、history、subscribedSymbols、extraSubscribedSymbols")
        Component(redux_preferences, "Redux preferences slice", "Redux Toolkit", "theme、language、notifications")
        Component(quote_subscriber, "QuoteSocketSubscriber", "React Native", "订阅合并符号")
        Component(redux_portfolio, "Redux portfolio slice", "Redux Toolkit", "selectedAccountId")
        
        Component(theme_system, "主题系统", "TypeScript", "浅色/深色配色；useTheme (useTheme.ts)")
        Component(styled_theme_provider, "StyledThemeProvider", "styled-components/native", "从 useTheme 注入 theme (colors) 到 styled-components")
        Component(theme_primitives, "主题基元", "styled-components/native", "ScreenRoot、ListRow、CardBordered、LabelText、ValueText、withTheme")
        Component(i18n_config, "i18n 配置", "TypeScript", "i18next 设置、翻译资源")
        Component(use_translation, "useTranslation", "Hook", "翻译 Hook")
        Component(period_data_processor, "PeriodDataProcessor", "TypeScript", "presentation/utils 周期过滤")
    }

    ' Application Layer
    Boundary(application_layer, "应用层") {
        Component(dependency_container, "DependencyContainer", "TypeScript", "依赖注入容器")
        Component(get_portfolio_usecase, "GetPortfolioUseCase", "TypeScript", "组合用例")
        Component(get_customer_usecase, "GetCustomerUseCase", "TypeScript", "客户用例")
        Component(get_quotes_usecase, "GetQuotesUseCase", "TypeScript", "报价用例")
        Component(risk_metrics_usecase, "RiskMetricsUseCase", "TypeScript", "风险指标、风险摘要、VaR 计算用例")
    }

    ' Domain Layer
    Boundary(domain_layer, "领域层") {
        Component(domain_entities, "领域实体", "TypeScript", "Portfolio、Quote、Customer 等")
        Component(portfolio_repo_interface, "IPortfolioRepository", "TypeScript", "组合仓库接口")
        Component(quote_repo_interface, "IQuoteRepository", "TypeScript", "报价仓库接口")
        Component(customer_repo_interface, "ICustomerRepository", "TypeScript", "客户仓库接口")
        Component(other_repo_interfaces, "其他仓库接口", "TypeScript", "UserPreference、Watchlist、Instrument 等")
    }

    ' Infrastructure Layer
    Boundary(infrastructure_layer, "基础设施层") {
        Component(http_client, "HttpClient", "TypeScript", "HTTP 客户端包装器")
        Component(quote_socket, "createQuoteSocket", "TypeScript", "WebSocket /ws/quotes")
        Component(api_config, "API Config", "TypeScript", "EXPO_PUBLIC_PORTFOLIO_API_URL")
        
        Component(portfolio_repo_impl, "PortfolioRepository", "TypeScript", "实现 IPortfolioRepository（薄客户端；将组合与风险逻辑委托给后端 API）")
        Component(quote_repo_impl, "QuoteRepository", "TypeScript", "实现 IQuoteRepository")
        Component(customer_repo_impl, "CustomerRepository", "TypeScript", "实现 ICustomerRepository")
        Component(other_repo_impls, "其他仓库", "TypeScript", "UserPreference、Watchlist 等")
        Component(accounts_api, "accountsApi", "TypeScript", "账户 API 客户端")
        Component(portfolio_api_client, "PortfolioApi", "TypeScript", "组合 API 客户端（组合、风险摘要、资产配置）")
        
        Component(web3_service, "web3Service", "TypeScript", "Web3 集成")
        Component(utils, "工具函数", "TypeScript", "infrastructure utils")
    }

    ' Native Components
    Boundary(native_layer, "原生组件") {
        Component(base_chart_view_manager, "BaseChartViewManager", "原生基类", "抽象 RCTViewManager")
        Component(base_chart_view, "BaseChartView", "原生基类", "抽象 UIView，包含 Metal")
        Component(base_chart_renderer, "BaseChartRenderer", "原生基类", "抽象 Metal 渲染器")
        Component(native_line_chart, "NativeLineChart", "原生视图", "Metal / OpenGL ES 图表")
    }
}

Container_Ext(portfolio_api, "投资组合分析 API", "REST / WebSocket", "组合、/ws/quotes、customers、accounts、payments、orders、trades、risk-metrics")

' Presentation to Application
Rel(use_portfolio_hook, dependency_container, "获取用例", "")
Rel(use_symbol_display_hook, dependency_container, "获取仓库", "")
Rel(use_preferences_hook, dependency_container, "获取仓库", "")
Rel(use_risk_metrics_hook, dependency_container, "获取用例", "")
Rel(use_risk_summary_hook, dependency_container, "获取用例", "")
Rel(use_computed_var_hook, dependency_container, "获取用例", "")
Rel(use_account_data_hook, dependency_container, "获取用例", "")

' Application to Domain
Rel(dependency_container, get_portfolio_usecase, "提供", "")
Rel(dependency_container, get_customer_usecase, "提供", "")
Rel(dependency_container, get_quotes_usecase, "提供", "")
Rel(dependency_container, risk_metrics_usecase, "提供", "")
Rel(get_portfolio_usecase, portfolio_repo_interface, "使用", "")
Rel(get_customer_usecase, customer_repo_interface, "使用", "")
Rel(get_quotes_usecase, quote_repo_interface, "使用", "")
Rel(risk_metrics_usecase, portfolio_repo_interface, "使用", "")

' Infrastructure implements Domain
Rel(portfolio_repo_impl, portfolio_repo_interface, "实现", "")
Rel(quote_repo_impl, quote_repo_interface, "实现", "")
Rel(customer_repo_impl, customer_repo_interface, "实现", "")
Rel(other_repo_impls, other_repo_interfaces, "实现", "")

' Application uses Infrastructure
Rel(dependency_container, portfolio_repo_impl, "提供", "")
Rel(dependency_container, quote_repo_impl, "提供", "")
Rel(dependency_container, customer_repo_impl, "提供", "")
Rel(dependency_container, other_repo_impls, "提供", "")

' Infrastructure to External API
Rel(portfolio_repo_impl, http_client, "使用", "")
Rel(quote_repo_impl, http_client, "使用", "")
Rel(customer_repo_impl, http_client, "使用", "")
Rel(http_client, api_config, "使用", "")
Rel(http_client, portfolio_api, "HTTP", "")
Rel(portfolio_api_client, portfolio_api, "HTTP", "/api/v1/portfolio, /api/v1/portfolio/risk-summary, /api/v1/portfolio/asset-allocation-by-account-type")
Rel(quote_socket, portfolio_api, "WebSocket", "/ws/quotes")
Rel(accounts_api, http_client, "使用", "")
Rel(accounts_api, portfolio_api, "HTTP", "")

' Presentation UI
Rel(app_content, use_preferences_hook, "使用", "")
Rel(app_content, tabs_router, "渲染", "")
Rel(tabs_router, overview_screen, "路由到", "")
Rel(tabs_router, watchlist_screen, "路由到", "")
Rel(tabs_router, analytics_screen, "路由到", "")
Rel(tabs_router, account_screen, "路由到", "")

Rel(overview_screen, use_portfolio_hook, "使用", "")
Rel(overview_screen, use_refresh_control_hook, "使用", "")
Rel(overview_screen, portfolio_summary, "使用", "")
Rel(overview_screen, asset_allocation_chart, "使用", "")
Rel(overview_screen, net_worth_chart, "使用", "")
Rel(overview_screen, native_line_chart, "使用", "")

Rel(watchlist_screen, use_portfolio_hook, "使用", "")
Rel(watchlist_screen, use_symbol_display_hook, "使用", "")
Rel(watchlist_screen, use_refresh_control_hook, "使用", "")
Rel(watchlist_screen, stock_list_item, "使用", "")
Rel(watchlist_screen, account_list_item, "使用", "")
Rel(watchlist_screen, stock_detail_drawer, "使用", "")
Rel(watchlist_screen, sort_menu, "使用", "")
Rel(watchlist_screen, glass_search_bar, "使用", "")

Rel(analytics_screen, use_risk_metrics_hook, "使用", "")
Rel(analytics_screen, use_risk_summary_hook, "使用", "")
Rel(analytics_screen, use_refresh_control_hook, "使用", "")
Rel(analytics_screen, use_computed_var_hook, "使用", "")
Rel(analytics_screen, metric_card, "使用", "")

Rel(account_screen, use_account_data_hook, "使用", "")
Rel(account_screen, use_refresh_control_hook, "使用", "")
Rel(account_screen, account_drawers, "使用", "")
Rel(account_screen, use_preferences_hook, "使用", "")

' Redux and State
Rel(use_symbol_display_hook, redux_quotes, "派发、选择", "")
Rel(quote_subscriber, redux_quotes, "派发", "")
Rel(quote_subscriber, quote_socket, "创建", "")
Rel(use_preferences_hook, redux_preferences, "派发、选择", "")

' Theme and i18n
Rel(overview_screen, use_theme_hook, "使用", "")
Rel(watchlist_screen, use_theme_hook, "使用", "")
Rel(analytics_screen, use_theme_hook, "使用", "")
Rel(account_screen, use_theme_hook, "使用", "")
Rel(app_content, styled_theme_provider, "包裹", "")
Rel(styled_theme_provider, use_theme_hook, "使用", "")
Rel(use_theme_hook, theme_system, "使用", "")
Rel(use_theme_hook, redux_preferences, "读取", "")
Rel(metric_card, theme_primitives, "使用", "")
Rel(account_drawers, theme_primitives, "使用", "")
Rel(theme_primitives, styled_theme_provider, "从…接收 theme", "")

Rel(overview_screen, use_translation, "使用", "")
Rel(watchlist_screen, use_translation, "使用", "")
Rel(analytics_screen, use_translation, "使用", "")
Rel(account_screen, use_translation, "使用", "")
Rel(use_translation, i18n_config, "使用", "")

' Native charts
Rel(native_line_chart, base_chart_view, "继承自", "")
Rel(native_line_chart, base_chart_renderer, "使用", "")
Rel(base_chart_view_manager, base_chart_view, "创建", "")
Rel(stock_detail_drawer, period_data_processor, "使用", "")

' Domain entities
Rel(portfolio_repo_interface, domain_entities, "返回", "")
Rel(quote_repo_interface, domain_entities, "返回", "")
Rel(customer_repo_interface, domain_entities, "返回", "")

LAYOUT_TOP_DOWN()

@enduml
